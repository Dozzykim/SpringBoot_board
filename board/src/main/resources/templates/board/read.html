<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ì¡°íšŒ</title>
    <style>
        .cmmt-box .inner {
            min-width: 500px;
            max-width: 100px;
            padding: 20px;
            border: 1px solid black;
        }

        .cmmt-box .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>ê²Œì‹œê¸€ ì¡°íšŒ</h1>

    <form action="/board/delete" method="post">
        <input type="hidden" name="no" th:value="${board.no}">
        <table>
            <tr>
                <td>ì œëª©</td>
                <td>
                    <input type="text" name="title" th:value="${board.title}">
                </td>
            </tr>
            <tr>
                <td>ì‘ì„±ì</td>
                <td>
                    <input type="text" name="writer" th:value="${board.writer}">
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <textarea name="content" id="content" cols="40" rows="5"
                              th:text="${board.content}"></textarea>
                </td>
            </tr>
            <tr>
                <td>íŒŒì¼</td>
                <td>
                    <ul>
                        <!-- íŒŒì¼ ëª©ë¡ -->
                        <th:block th:each="file : ${fileList}">
                            <li>
                                <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ -->
                                <img th:src="|/file/img/${file.no}|" alt="ì¸ë„¤ì¼" width="200" />
                                <!-- íŒŒì¼ëª… (ë‹¤ìš´ë¡œë“œ) -->
                                <a th:href="|/file/${file.no}|" th:text="${file.originName}"></a>
                                <!-- íŒŒì¼ ì‚­ì œ -->
                                <button type="button" th:onclick="|deleteFile(this,${file.no})|">ì‚­ì œ</button>
                            </li>
                        </th:block>
                    </ul>
                </td>
            </tr>
        </table>
        <div>
            <button type="button" onclick="moveUpdate()">ìˆ˜ì •</button>
            <button type="button" onclick="moveList()">ëª©ë¡</button>
        </div>
    </form>

    <!-- ëŒ“ê¸€ ì…ë ¥ -->
    <div id="reply-input">
        <h3>ëŒ“ê¸€</h3>
        <div class="reply-input">
            <input type="text" name="writer" id="cmmt-writer" class="cmmt-writer" placeholder="ì‘ì„±ì">
            <br>
            <textarea name="content" id="cmmt-content" cols="60" rows="5" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
            <div class="btn-box">
                <button type="button" id="btn-cmmt-insert" class="btn-cmmt" onclick="insertCmmt()">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div id="cmmt-list">

    </div>


    <script>

        // ğŸ‘©â€ğŸ’» ëª¨ë¸ ê°ì²´ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•
        let no = "[[${board.no}]]" // ê¸€ë²ˆí˜¸

        // ëŒ“ê¸€ ëª©ë¡ ìš”ì²­
        cmmtList()
        

        // ìˆ˜ì • í™”ë©´ ì´ë™
        function moveUpdate() {
            location.href = '/board/update?no=' + no
        }

        // ëª©ë¡ í™”ë©´ ì´ë™
        function moveList() {
            location.href = '/board/list'
        }

        function deleteFile(element, no) {
            alert(no);
            // AJAX ë¹„ë™ê¸° ìš”ì²­
            let data = {
                no : no
            }

            let request = new XMLHttpRequest();

            // ìš”ì²­ ì„¸íŒ…
            // request.open(ìš”ì²­ë©”ì†Œë“œ, URL)
            request.open('DELETE', '/file/' + no);
            request.send();

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µì‹œ,
                if(request.readyState == request.DONE && request.status == 200) {
                    console.log('íŒŒì¼ ì‚­ì œ ì„±ê³µ!');

                    // íŒŒì¼ í•­ëª© ì œê±°
                    element.parentNode.remove();
                }
            }
        }

        // ì¢…ì†ëœ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
        function cmmtList() {

            // AJAX ë¹„ë™ê¸° ìš”ì²­
            let request = new XMLHttpRequest();

            // ìš”ì²­ ì„¸íŒ…
            // request.open(ìš”ì²­ë©”ì†Œë“œ, URL)
            request.open('GET', '/cmmt/' + no);
            request.send();

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µì‹œ,
                if(request.readyState == request.DONE && request.status == 200) {
                    // ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥
                    let response = request.responseText
                    
                    // â­ì„œë²„ì—ì„œ ë Œë”ë§í•œ HTMLë¡œ ê°±ì‹ (SSR)
                    let data = response; // (HTML)


                    /*
                    // â­JSON ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ì•„ HTMLë¡œ ë³€í™˜(CSR)
                    let cmmtListData = JSON.parse(response); // JSON -> Array ë°°ì—´ë¡œ ë³€í™˜
                    console.log(response);
                    
                    let data = ``
                    for(var i in cmmtListData) {
                        data += `<div class="cmmt-box">`;
                        data += `<div class="inner">`
                        let writer = cmmtListData[i].writer;    // ì‘ì„±ì
                        let content = cmmtListData[i].content;  // ëŒ“ê¸€ ë‚´ìš©
                        let regDate = cmmtListData[i].regDate;  // ì‘ì„± ì¼ì

                        data += `<div class="top">`
                        data += `<span class="cmmt-writer">${writer}</span>`
                        data += `<span class="cmmt-date">${regDate}</span>`

                        data += `<div class="item">`
                        data += `<button class="btn-cmmt-update">ìˆ˜ì •</button>`
                        data += `<button class="btn-cmmt-delete">ì‚­ì œ</button>`
                        data += `</div>`; // item divíƒœê·¸
                        data += `</div>`; // top divíƒœê·¸

                        data += `<p class="cmmt-content">${content}</p>`
                        data += `<button class="btn-cmmt-answer">ë‹µê¸€</button>`

                        data += `</div>`; // inner divíƒœê·¸
                        data += `</div>`; // cmmt-box divíƒœê·¸
                    } */

                    /*
                    // forë¬¸ì„ ë‹¤ë¥´ê²Œ ì¨ë³¼ ìˆ˜ ìˆìŒ

                    for( let i=0; i<cmmtListData.length; i++ ) {
                        let writer = cmmtListData[i].writer;
                        let content = cmmtListData[i].content;
                        let li = `<li>${content}</li>`
                        data += li
                    }
                    */

                    let cmmtList = document.getElementById('cmmt-list');
                    cmmtList.innerHTML = data;

                    // ëŒ“ê¸€ ìˆ˜ì •ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ 
                    event()
                }
            }
        }

        // ëŒ“ê¸€ ë“±ë¡
        function insertCmmt() {
            let $writer = document.getElementById('cmmt-writer');
            let $content = document.getElementById('cmmt-content');
            let writer = $writer.value;
            let content = $content.value;

            let data = {
                'boardNo': no,
                'writer': writer,
                'content' : content
            }
            // console.dir(data) //dir -> ê°ì²´ë¡œ ë¬¶ì—¬ìˆëŠ” ì• ë“¤ì„ ë¡œê·¸ë¡œ ë³¼ ìˆ˜ ìˆìŒ

            let request = new XMLHttpRequest();

            request.open('POST', '/cmmt');
            request.setRequestHeader('content-Type', 'application/json')
            request.send(JSON.stringify(data)) // JSì˜ Object(ê°ì²´)í˜•íƒœë¥¼ javaê°€ ì½ì„ ìˆ˜ ì—†ì–´ì„œ, ë¬¸ìì—´ í˜•íƒœë¡œ ë³€í™˜í•´ì£¼ì–´ì•¼í•¨.

            // ìš”ì²­ ìƒíƒœ ì²´í‚¹
            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µì‹œ,
                if(request.readyState == request.DONE && request.status == 201) {
                    console.log('ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ!');

                    // alert(request.responseText); // ì‘ë‹µë©”ì‹œì§€ë¡œ ë³´ëƒˆë˜ 'SUCCESS' í™•ì¸í•´ë³´ëŠ” ê³¼ì •
                    let response = request.responseText;
                    if(response == 'SUCCESS') {
                        cmmtList(); // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 

                        // ëŒ“ê¸€ ì…ë ¥ì°½ ë¹„ìš°ê¸°
                        $writer.value = '';
                        $content.value = '';
                    }
                }
            }
        }

        //
        function event() {
            
            // ëŒ“ê¸€ ìˆ˜ì • ë²„íŠ¼
            let $btnUpdate = document.getElementsByClassName('btn-cmmt-update');
        
            // ëŒ“ê¸€ ìˆ˜ì • í´ë¦­ ì´ë²¤íŠ¸
            for( let i=0; i < $btnUpdate.length; i++){
                $btnUpdate[i].addEventListener('click', function() {
                    // alert('ìˆ˜ì •ë²„íŠ¼ í´ë¦­');

                    // í•´ë‹¹ ëŒ“ê¸€ì˜ ì‘ì„±ì, ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê¸°
                    // $btnUpdate[i] : í˜„ì¬ìš”ì†Œ (ìˆ˜ì •ë²„íŠ¼)
                    
                    let $top = $btnUpdate[i].parentNode.parentNode;
                    let writer = $top.childNodes[1].textContent;
                    let $inner = $top.parentNode;
                    let content = $inner.childNodes[3].textContent;
                    let $cmmtBox = $inner.parentNode

                    let no = $btnUpdate[i].getAttribute('data'); // ëŒ“ê¸€ë²ˆí˜¸ ê°€ì ¸ì˜´
                    //console.log(`ì‘ì„±ì: ${writer}`);
                    //console.log(`ë‚´ìš©: ${content}`);

                    // ëŒ“ê¸€ ìˆ˜ì • ëª¨ë“œ
                    // 1. ê¸°ì¡´ ëŒ“ê¸€ ë‚´ìš©ì°½ ìˆ¨ê¸°ê¸°
                    $inner.style.display = 'none';

                    // 2. ìˆ˜ì • UI ì¶œë ¥
                    let $editor = document.createElement('div');
                    $editor.classList.add('inner');
                    $editor.id = 'editor';

                    let editor = ``;
                    //editor += `<div class="inner" id="editor">`;
                    editor += `<input type="text" placeholder="ì‘ì„±ì" value="${writer}" id="update-writer"/>`;
                    editor += `<br>`;
                    editor += `<textarea cols="60" rows="5" id="update-content">${content}</textarea>`;
                    editor += `<br>`;
                    editor += `<button onclick="updateCmmt(${no})">ìˆ˜ì •</button>`;
                    editor += `<button onclick="cancelCmmt()">ì·¨ì†Œ</button>`;
                    //editor += `</div>`;
                    $editor.innerHTML = editor;
                    $cmmtBox.appendChild($editor);
                })
            }
        }

        // ëŒ“ê¸€ ìˆ˜ì •ìš”ì²­
        function updateCmmt(no) {
            // alert('ìˆ˜ì • ìš”ì²­')
            let writer = document.getElementById('update-writer').value;
            let content = document.getElementById('update-content').value;

            console.log(`ìˆ˜ì •í•œ ëŒ“ê¸€ë²ˆí˜¸:  ${no}`);
            console.log(`ìˆ˜ì •í•œ ì‘ì„±ì:  ${writer}`);
            console.log(`ìˆ˜ì •í•œ ë‚´ìš©:  ${content}`);

            let data = {
                'cno'    : no,  // 'cNo' : no ë¼ê³  í‚¤ê°’ì„ ì£¼ë©´ ë§¤í•‘ì´ ì•ˆë˜ëŠ” ë¬¸ì œê°€ ìˆì–´ 'cno'ë¡œ ì„¤ì •í•¨.
                'writer': writer,
                'content': content
            }

            console.dir(data);
            
            // Ajax ë¹„ë™ê¸° ìš”ì²­
            let request = new XMLHttpRequest();
            request.open('PUT', '/cmmt');
            request.setRequestHeader('Content-Type', 'application/json')
            request.send(JSON.stringify(data))

            // ìš”ì²­ ìƒíƒœ ì²´í‚¹
            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µì‹œ,
                if(request.readyState == request.DONE && request.status == 200) {
                    console.log('ëŒ“ê¸€ ìˆ˜ì • ì„±ê³µ!');

                    // alert(request.responseText); // ì‘ë‹µë©”ì‹œì§€ë¡œ ë³´ëƒˆë˜ 'SUCCESS' í™•ì¸í•´ë³´ëŠ” ê³¼ì •
                    let response = request.responseText;
                    alert(response)
                    if(response == 'SUCCESS') {
                        console.log('success!!!!')
                        cmmtList(); // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                    }
                }
            }
        }
        
        // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
        function cancelCmmt() {
            alert('ì·¨ì†Œ ìš”ì²­')
            let $editor = document.getElementById('editor');
            $editor.remove();

            let $inner = document.getElementsByClassName('inner');
            for(var i in $inner) {
                $inner[i].style.display = 'block';
            }

            event()
        }

        // ëŒ“ê¸€ ìˆ˜ì •ìš”ì²­
        function deleteCmmt(no) {
            // ì‚­ì œ ìš”ì²­
            // Ajax ë¹„ë™ê¸° ìš”ì²­
            let request = new XMLHttpRequest();
            request.open('DELETE', '/cmmt/' + no);
            request.send()

            // ìš”ì²­ ìƒíƒœ ì²´í‚¹
            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µì‹œ,
                if(request.readyState == request.DONE && request.status == 200) {
                    console.log('ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ!');

                    // alert(request.responseText); // ì‘ë‹µë©”ì‹œì§€ë¡œ ë³´ëƒˆë˜ 'SUCCESS' í™•ì¸í•´ë³´ëŠ” ê³¼ì •
                    let response = request.responseText;
                    if(response == 'SUCCESS') {
                        cmmtList(); // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                    }
                }
            }
        }
    </script>
</body>
</html>